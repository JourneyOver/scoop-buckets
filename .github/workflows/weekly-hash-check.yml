name: Weekly Hash Check

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 0"

permissions:
  contents: read
  issues: write

concurrency:
  group: weekly-hash-check
  cancel-in-progress: false

jobs:
  hash-check:
    name: Check Hashes
    runs-on: windows-latest
    steps:
      - name: Checkout Bucket
        uses: actions/checkout@main

      - name: Checkout Scoop
        uses: actions/checkout@main
        with:
          repository: ScoopInstaller/Scoop
          path: scoop_core

      - name: Run hash checks for all manifests
        shell: pwsh
        continue-on-error: true
        run: |
          $env:SCOOP_HOME = "$(Convert-Path '.\scoop_core')"
          $logPath = Join-Path $env:GITHUB_WORKSPACE 'checkhashes.log'
          $cacheDir = 'D:\a\cache'
          if (-not (Test-Path -LiteralPath $cacheDir)) {
            New-Item -Path $cacheDir -ItemType Directory -Force | Out-Null
          }

          if (Test-Path -LiteralPath $logPath) {
            Remove-Item -LiteralPath $logPath -Force
          }

          New-Item -Path $logPath -ItemType File -Force | Out-Null

          .\bin\checkhashes.ps1 "*" *>&1 | Tee-Object -FilePath $logPath -Append

      - name: Parse checkhashes output
        id: parse
        shell: pwsh
        run: |
          $logPath = Join-Path $env:GITHUB_WORKSPACE 'checkhashes.log'

          if (Test-Path -LiteralPath $logPath) {
            .\scripts\ci\parse-checkhashes-output.ps1 -InputPath $logPath -OutputPath .\hash-issues.json
          }
          else {
            '[]' | Set-Content -Path .\hash-issues.json -Encoding utf8
          }

          if (-not (Test-Path -LiteralPath .\hash-issues.json)) {
            '[]' | Set-Content -Path .\hash-issues.json -Encoding utf8
          }

          $parsed = Get-Content -Raw -Path .\hash-issues.json | ConvertFrom-Json
          if ($parsed -is [array]) {
            $count = $parsed.Count
          }
          elseif ($null -eq $parsed) {
            $count = 0
          }
          else {
            $count = 1
          }

          "count=$count" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Create issues for mismatched hashes
        if: steps.parse.outputs.count != '0'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ISSUE_TRIGGER_TOKEN != '' && secrets.ISSUE_TRIGGER_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const raw = fs.readFileSync('./hash-issues.json', 'utf8');
            const parsed = JSON.parse(raw);
            const issuesToCreate = Array.isArray(parsed) ? parsed : [parsed];

            const existingIssues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            for (const issue of issuesToCreate) {
              if (!issue?.title || !issue?.body) {
                continue;
              }

              const duplicate = existingIssues.find((existing) => existing.title === issue.title);
              if (duplicate) {
                core.info(`Skipping existing issue: ${issue.title}`);
                continue;
              }

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issue.title,
                body: issue.body
              });

              core.info(`Created issue: ${issue.title}`);
            }

      - name: Upload hash check log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkhashes-log
          path: ${{ github.workspace }}/checkhashes.log
          if-no-files-found: ignore
